---
layout: post
title:  "yii2 数据模型 -- 基于场景的验证"
date:   2016-06-14 20:11:39 +0800
categories: 随笔
tags: 
- yii2
- Model
- 基于场景的验证
- 规则 
- 场景

published: true
---

<!--
破vim 回头高两件事
1. 自动保存
2. 自动折行换行
-->

<!--先说一坨可能的实际遇到的情况, 爆料一下人世间的各种苦难 -->

系统交互的过程中，对数据的接收方来说，对数据的格式、内容的校检、验证至关重要。
比如后端在接受注册用户的数据时候，需要对传送过来的邮箱、手机号、用户密码、填
写的外链url、注册地点ip等每种格式都需要验证是否符合对应的规范，有时还需要根据
数据库中的现有数据，判断新注册的登陆用户名不能重复,有时还邮箱跟手机号两个二选
一即可,有时情况很多、、、每一项验证不是单纯的只验证自己，还有可能依赖对其他的
验证结果验证不验证。在更新用户信息的时候，仔细观察后就会发现上述每一项的验证规
则此处也是必需品。

<!-- 救世主降生 -->
在旧社会，没有什么的好的工具可以使用，生猛点的直接编写代码对中的字段进行验证，

使用框架提供的手段

<!--如何使用救世主拯救 -->

## rules() 能用来做什么？

```php

class User extends yii\base\Model  {
    public $mobile;
    public $email;
    public $username;
    public $password;
    public $reg_ip;
    public $weibo_url;

    const  SCENARIO_REG = 'reg';

    public function rules() {
        return [
            //邮箱、手机号必有一个不为空
            [['email'], 'required', 'when' => function(self $model) {
               return !(new \yii\validators\RequiredValidator())
                            ->validate($model->mobile);
            }],
            ['email', 'email'],
            ['reg_ip', 'ip'],
            //数据库中值唯一
            ['username','unique', 'on' => [
                self::SCENARIO_REG
            ]],
            //用户名，密码长度至少为8，最多为16
            ['username', 'string','length' => [8,16]],
            ['password', 'string', 'min' => 8, 'max' => 20],

             //用户名只含有52英文字母表字幕及数字，且只能以字母开始
            ['username', 'match', 'pattern' => '/[a-zA-Z]+[a-zA-Z0-9]*/'],
        ];
    }

}

$model = new User();
$model->load($_POST, '');
if(!$model->validate()) {
    Yii::error($model->getErrors(),'DATA_VALIDATION');
    ...
}

...

```

返回对各个字段属性的验证规则

对`on`属性的注意：

- 没有指定 `on` 属性的字段，规则会在所有场景中都被启用
- `on`的值可以为字符串,`'scenarino'` 单个场景中起作用
- `on`的值可以为数组`['scenrino1',scenarino2]`多个场景中起作用

## scenarios() 场景

返回当前`model`的所有场景，以及每种场景下可以进行块赋值（安全的）和不可以进行块赋值（非安全）的属性

- 有一个默认场景`default`
- 没有覆盖重写
	+ 返回rules里面发现的所有场景和对应的属性，默认是属性是安全的可以进行块赋值
- 重写手动指定属性在每种场景中是否是安全的

<!-- 救世主的内部构造是怎么样的 -->

<!-- 救世主的内部构造是为什么是这样的 -->

