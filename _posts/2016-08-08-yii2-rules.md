---
layout: post
title:  "yii2 数据模型 -- 基于场景的验证"
date:   2016-06-14 20:11:39 +0800
categories: 随笔
tags: 
- yii2
- Model
- 基于场景的验证
- 规则 
- 场景

published: true
---

<!--
破vim 回头高两件事
1. 自动保存
2. 自动折行换行
-->

<!--先说一坨可能的实际遇到的情况, 爆料一下人世间的各种苦难 -->

系统交互的过程中，对数据的接收方来说，对数据的格式、内容的校检、验证至关重要。
比如后端在接受注册用户的数据时候，会对传送过来的邮箱、手机号、用户密码、填
写的外链url、注册地点ip等每种格式都需要验证是否符合对应的规范，有时还需要根据
数据库中的现有数据，判断新注册的登陆用户名是否重复,有时不只是单纯的验证某一项，
需要依赖对其他的项的验证结果来决定是否验证,比如邮箱跟手机号两个二选一即可。
有时换到另外一种场景，如在更新用户信息的时候，仔细观察后就会发现上述验证规则
有很大的重复。

针对这些问题，在yii2中是使用元编程的思路，给出了一种很优雅的解决方式 --- Validator。

yii2 的Validator实现跟数据模型Model有很多的互相交互、依赖。下面给出以下从Model
层面的使用样例。

<!-- 救世主降生 -->


<!--如何使用救世主拯救 -->

## 样例

针对上述提到的几个问题，在yii2中的解法如下，仅仅使用了一个数组就描述清楚的每个字段在
不同场景下的验证规则，关于核心验证器的用法参考yii2权威指南-核心验证器相关章节：

```php

class User extends yii\base\Model  {
    public $mobile;
    public $email;
    public $username;
    public $password;
    public $reg_ip;
    public $weibo_url;

    const  SCENARIO_REG = 'reg';

    public function rules() {
        return [
            //邮箱、手机号必有一个不为空
            [['email'], 'required', 'when' => function(self $model) {
               return !(new \yii\validators\RequiredValidator())
                            ->validate($model->mobile);
            }],
            //检查邮箱、ip的数据格式
            ['email', 'email'],
            ['reg_ip', 'ip'],
            //数据库中值唯一
            ['username','unique', 'on' => [
                self::SCENARIO_REG
            ], 'message' => '你的用户名TMD热门了，已被占用，再换一个吧！！！'],
            //用户名，密码长度至少为8，最多为16
            ['username', 'string','length' => [8,16]],
            ['password', 'string', 'min' => 8, 'max' => 20],

             //用户名只含有52英文字母表字幕及数字，且只能以字母开始
            ['username', 'match', 'pattern' => '/[a-zA-Z]+[a-zA-Z0-9]*/'],
        ];
    }

}

$model = new User();
$model->setScenario('default');
$model->load($_POST, '');
if(!$model->validate()) {
    Yii::error($model->getErrors(),'DATA_VALIDATION');
    ...
}

...

```


上述返回数组的每一个元素就是针对不同的字段、属性在不同的场景下的验证规则，其格式如下

`[attributes array/string, validator aliase or closure, validator property init list ...]`

- attributes array/string 使用本条验证规则的属性如果只有一个属性、字段可以是一个字符串，否则为数组形式
- validate aliase or closure ，这是yii2 给其自己内部实现的一组核心验证器（都是Validator的子类）的别名, 如果不是没有这个别名就会查
看数据模型Model子类是否有这个同名的方法，也可以直接是一个闭包。后两种方式都是封装在一个InlineValidator中实现的。
- 再往后就是一些关联数组，每一对都是针对每个Core Validator属性的初始化。

如此清晰易读的语法形式和初始化列表功能的存在，完全得益于yii2的基于配置这个特性。

## 场景 scenario

场景本身也没什么，就是用来告诉验证器当前是在哪个场景之下，是在注册、
还是在更新用户。实际使用时，设置完场景`setScenario` 调用 `validate`
yii2 就可以自动选定用那些规则进行验证。


### `on` `except` 属性：


`on`是用来指定当前的验证规则是在那些场景下启用。

- 没有指定 `on` 属性的字段，规则会在所有场景中都被启用
- `on`的值可以为字符串,`'scenarino'` 单个场景中起作用
- `on`的值可以为数组`['scenrino1',scenarino2]`多个场景中起作用

`except` 和 `on` 类似，只是用来说明那些场景不启用当前规则。有个值得注意的问题就是`on`和`except`同时指定的时候只有`on`才会起效。


### `message` 属性

当验证规则失败的时候，用于指定自定义的错误返回信息

###  scenarios() 场景

这是数据模型的方法用来返回，场景之下
返回当前`model`的所有场景，以及每种场景下可以进行块赋值（安全的）和不可以进行块赋值（非安全）的属性

- 有一个默认场景`default`
- 没有覆盖重写
	+ 返回rules里面发现的所有场景和对应的属性，默认是属性是安全的可以进行块赋值
- 重写手动指定属性在每种场景中是否是安全的

<!-- 救世主的内部构造是怎么样的 -->

<!-- 救世主的内部构造是为什么是这样的 -->

